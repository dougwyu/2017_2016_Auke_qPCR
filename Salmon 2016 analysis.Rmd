---
title: "Sockeye qPCR by Sockeye counts"
author: "Douglas Yu"
date: "26/07/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Set up github remote on https://github.com/dougwyu/2017_2016_Auke_qPCR
https://www.r-bloggers.com/rstudio-and-github/
Open Terminal
```{bash, }
git remote add origin https://github.com/dougwyu/2017_2016_Auke_qPCR.git
git config remote.origin.url git@github.com:dougwyu/2017_2016_Auke_qPCR.git
git pull -u origin master
git push -u origin master
```
Pull and Push buttons are now active
https://github.com/dougwyu/2017_2016_Auke_qPCR

```{r}
# add packages that I will use
library(tidyverse) # includes all data-formatting packages as one big package (e.g. ggplot2, tibble, tidyr, readr, purrr, dplyr) # use dplyr::filter, dplyr::lag
library(readxl)
library(knitr)
library(zoo)  # time series R "infrastructure" package
library(cowplot)
```

```{r}
inputfile <- "AukeCreek_Sockeye_2016_qPCRVsCount_20170802.2.xlsx"

sockeye_qpcr <- read_excel(inputfile, "Ct_Sockeye_2016_work", col_names = TRUE, col_types = c("date","numeric","text","text","text","numeric","text","text","text","numeric","numeric","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip"), na = "NA")

sockeye_env <- read_excel(inputfile, "Summary", col_names = TRUE, col_types = c("skip","skip","skip","skip","skip","date","numeric","numeric","numeric","numeric","numeric","date","numeric","numeric","numeric","numeric"), na = "NA", n_max = 170)  # check number of rows to be input.  
```


```{r}
names(sockeye_qpcr)
# [1] "Date"            "orig_order"      "Plate_ID"        "Well"           
# [5] "SampleID"        "SampleNumber"    "SampleReplicate" "CT_omit"        
# [9] "updownstream"    "CT"              "Qty_ng_per_ul"  

names(sockeye_env)
# [1] "Date"              "Smolts"            "Sockeye_Male"     
# [4] "Sockeye_Female"    "Sockeye_Jack"      "SockeyeTotalCount"
# [7] "Water_Date"        "Gage_Height"       "Depth_inches"     
# [10] "Q_cfs"             "Avg_Temp"

```


```{r}
# keep ONLY ONE SET of qPCRs per sampleID and remove rows that have no CT value
sockeye_qpcr_filtered <- sockeye_qpcr %>% filter(CT_omit == "no_omit") %>% filter(CT != "NA")

# OR keep ALL SETS of qPCRs per sampleID and remove rows that have no CT value
sockeye_qpcr_filtered <- sockeye_qpcr %>% filter(CT != "NA")

sockeye_qpcr_summary <- sockeye_qpcr_filtered %>% group_by(SampleID) %>% summarise(Date = first(Date), Plate_ID = first(Plate_ID), SampleNumber = first(SampleNumber), SampleReplicate = first(SampleReplicate), updownstream = first(updownstream), CT_mean = mean(CT, na.rm=TRUE), CT_sd = sd(CT, na.rm=TRUE), Qty_ng_per_ul_mean = mean(Qty_ng_per_ul, na.rm=TRUE), Qty_ng_per_ul_sd = sd(Qty_ng_per_ul, na.rm=TRUE), n_qpcrs = n()) %>% arrange(Date)

names(sockeye_qpcr_summary)
# [1] "Date"               "SampleID"           "Plate_ID"          
# [4] "SampleNumber"       "SampleReplicate"    "updownstream"      
# [7] "CT_mean"            "CT_sd"              "Qty_ng_per_ul_mean"
# [10] "Qty_ng_per_ul_sd"   "n_qpcrs"   

sockeye_qpcr_env <-  left_join(sockeye_qpcr_summary, sockeye_env, by = "Date")

sockeye_qpcr_env_adults <- sockeye_qpcr_env %>% filter(updownstream == "upstream")
```

At this point, the dataset sockeye_qpcr_env should have one row per water sample (SampleID). Since there are two water samples per day, there should be an even number of rows (sampling days X 2), but some water samples failed completely in qPCR, so the final number of rows is 243.  The salmon count and water data are thus repeated over the two water samples.  

For graphing, the sockeye_qpcr_env dataset will need to be separated into two subdatasets (SampleReplicate == A or == B), or do a summarise by SampleNumber, not SampleID.  

```{r}
names(sockeye_qpcr_env)
#  [1] "SampleID"           "Date"               "Plate_ID"          
#  [4] "SampleNumber"       "SampleReplicate"    "updownstream"      
#  [7] "CT_mean"            "CT_sd"              "Qty_ng_per_ul_mean"
# [10] "Qty_ng_per_ul_sd"   "n_qpcrs"            "Smolts"            
# [13] "Sockeye_Male"       "Sockeye_Female"     "Sockeye_Jack"      
# [16] "SockeyeTotalCount"  "Water_Date"         "Gage_Height"       
# [19] "Depth_inches"       "Q_cfs"              "Avg_Temp"  


sockadults <- ggplot(sockeye_qpcr_env_adults, aes(Date, SockeyeTotalCount)) + geom_line() +
  xlab("") + ylab("Adult Counts")
sockqpcr <- ggplot(sockeye_qpcr_env_adults, aes(Date, Qty_ng_per_ul_mean)) + geom_line() +
  xlab("") + ylab("qPCR conc")
Q_cfs <- ggplot(sockeye_qpcr_env_adults, aes(Date, Q_cfs)) + geom_line() + xlab("") + ylab("Q_cfs")
temp <- ggplot(sockeye_qpcr_env_adults, aes(Date, Avg_Temp)) + geom_line() + xlab("") + ylab("Avg Temp")
water <- ggplot(sockeye_qpcr_env_adults, aes(Date, Gage_Height)) + geom_line() + xlab("") + ylab("Gage Height")
plot_grid(sockadults, sockqpcr, Q_cfs, water, temp, nrow = 5, align = "v")
```

http://ggplot2.tidyverse.org/reference/facet_grid.html
https://cran.r-project.org/web/packages/cowplot/vignettes/introduction.html

```{r}
ccf() # used to calculate cross-correlation of two univariate time series
```

https://onlinecourses.science.psu.edu/stat510/node/75/
https://stats.stackexchange.com/questions/29096/correlation-between-two-time-series
https://svds.com/avoiding-common-mistakes-with-time-series/
