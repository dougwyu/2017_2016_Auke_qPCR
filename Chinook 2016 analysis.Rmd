---
title: "Sockeye qPCR by Sockeye counts"
author: "Douglas Yu"
date: "26/07/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# add packages that I will use
library(tidyverse) # includes all data-formatting packages as one big package (e.g. ggplot2, tibble, tidyr, readr, purrr, dplyr) # because of conflicts, use:  dplyr::filter, dplyr::lag
library(readxl)
library(knitr)
library(zoo)  # time series R "infrastructure" package
library(cowplot)
library(nlme)
library(MuMIn)


```


```{r sockeye input}
inputfile_qpcr <- "data/AukeCreek_Chinook_2016_Results_20170830.xlsx"
inputsheet_qpcr <- "ChinookResults"
inputfile_env <- "data/AukeCreek_Sockeye_2016_qPCRVsCount_20170802.2.xlsx"
inputsheet_env <- "Summary"

salmon_qpcr <- read_excel(inputfile_qpcr, inputsheet_qpcr, col_names = TRUE, col_types = c("numeric","text","text","numeric","text","date","text","text","text","text","numeric","numeric","numeric","numeric","numeric","numeric","text"), na = "NA")

salmon_env <- read_excel(inputfile_env, inputsheet_env, col_names = TRUE, col_types = c("skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","skip","date","numeric","numeric","numeric","numeric","date","numeric","numeric","numeric"), na = "NA", n_max = 170)  # check number of rows to be input.  

```


```{r}
names(salmon_qpcr)
#  [1] "orig_order"      "Well"            "Sample_Name"     "SampleID"       
#  [5] "SampleReplicate" "SampleDate"      "Target_Name"     "Task"           
#  [9] "Reporter"        "Quencher"        "Cт"              "Cт_Mean"        
# [13] "Cт_SD"           "Quantity"        "Quantity_Mean"   "Quantity_SD"    
# [17] "PlateID"  
# 
names(salmon_env)
# [1] "Water_Date"    "Gage_Height"   "Depth_inches"  "Q_cfs"        
# [5] "Avg_Temp"      "Date"          "Chinook_Adult" "Chinook_Mini" 
# [9] "Chinook_Total"

```
Q_cfs is measure of flux, aka discharge:  cubic feet per second(?).  Cross sectional area X water velocity

The first chinook are recorded on 25 July 2016, so the qPCR values before that date (20-24 July 2016) have lots of Undetermined CT values, which essentially means chinook concentrations of 0.  I would normally just replace with 0, but another cause of Undetermined CT values is that the qPCR failed, even though there is DNA.  This occurs in some of the later samples where chinook counts > 0, e.g. 1 out of 3 replicates, where the other 2 replicates detect chinook DNA. So I cannot just tidyr::replace_na with 0;  that would result in incorrectly reduced means for these later samples.

Thus, i am going to just summarise and allow NAs to be omitted from the summaries, but record the n per mean. 

# tidyr code
# df %>% replace_na(list(x = 0, y = "unknown"))

```{r}
salmon_qpcr_summary <- salmon_qpcr %>% group_by(Sample_Name) %>% summarise(SampleID = first(SampleID), SampleReplicate = first(SampleReplicate), SampleDate = first(SampleDate), CT_mean = mean(Cт, na.rm=TRUE), CT_sd = sd(Cт, na.rm=TRUE), Qty_ng_per_ul_mean = mean(Quantity, na.rm=TRUE), Qty_ng_per_ul_sd = sd(Quantity, na.rm=TRUE), n_qpcrs = sum(!is.na(Cт))) %>% arrange(SampleDate)

# n_qpcrs = sum(!is.na(Cт)) # count number of CT values that are *not* "Undetermined"

names(salmon_qpcr_summary)
# [1] "Sample_Name"        "SampleID"           "SampleReplicate"   
# [4] "SampleDate"         "CT_mean"            "CT_sd"             
# [7] "Qty_ng_per_ul_mean" "Qty_ng_per_ul_sd"   "n_qpcrs"     
 
names(salmon_env)
# [1] "Water_Date"    "Gage_Height"   "Depth_inches"  "Q_cfs"        
# [5] "Avg_Temp"      "Date"          "Chinook_Adult" "Chinook_Mini" 
# [9] "Chinook_Total"

salmon_qpcr_env <-  left_join(salmon_qpcr_summary, salmon_env, by = c("SampleDate" = "Date"))  # join by two columns with different colnames

salmon_qpcr_env <- salmon_qpcr_env %>% mutate(Qcfscorr_qpcr = Qty_ng_per_ul_mean*(max(Q_cfs)/Q_cfs))

salmon_qpcr_env <- salmon_qpcr_env %>% mutate(Gagecorr_qpcr = Qty_ng_per_ul_mean*(max(Gage_Height)/Gage_Height))

```

At this point, the dataset salmon_qpcr_env should have one row per water sample (Sample_Name). Since there are two water samples per day (SampleReplicate = A & B), there should be an even number of rows (sampling days X 2).  The final number of rows is indeed even:  96.  The salmon count and water data are thus repeated over the two water samples.  

For graphing, the sockeye_qpcr_env dataset will need to be separated into two subdatasets (SampleReplicate == A or == B). Alternatively, redo the above but summarise by SampleID, not Sample_Name  

```{r}
# only analyse sampleReplicate A or B
salmon_qpcr_env_A <- salmon_qpcr_env %>% filter(SampleReplicate == "A")
salmon_qpcr_env_B <- salmon_qpcr_env %>% filter(SampleReplicate == "B")

salmon_qpcr_env_use <- salmon_qpcr_env_A # B has a few more samples where only one qPCR succeeded (mostly before chinook started)

names(salmon_qpcr_env_use)
#  [1] "Sample_Name"        "SampleID"           "SampleReplicate"   
#  [4] "SampleDate"         "CT_mean"            "CT_sd"             
#  [7] "Qty_ng_per_ul_mean" "Qty_ng_per_ul_sd"   "n_qpcrs"           
# [10] "Water_Date"         "Gage_Height"        "Depth_inches"      
# [13] "Q_cfs"              "Avg_Temp"           "Chinook_Adult"     
# [16] "Chinook_Mini"       "Chinook_Total"      "Qcfscorr_qpcr"     
# [19] "Gagecorr_qpcr"    

salmoncount1 <- ggplot(salmon_qpcr_env_use, aes(SampleDate, Chinook_Adult)) + geom_line() + xlab("") + ylab("Adult Counts") + background_grid(major = "x", minor="x", size.minor = 0.5, colour.minor = "grey90")
salmoncount2 <- ggplot(salmon_qpcr_env_use, aes(SampleDate, Chinook_Mini)) + geom_line() + xlab("") + ylab("Mini Counts") + background_grid(major = "x", minor="x", size.minor = 0.5, colour.minor = "grey90")
salmonqpcr <- ggplot(salmon_qpcr_env_use, aes(SampleDate, Qty_ng_per_ul_mean)) + geom_line() + xlab("") + ylab("qPCR conc") + background_grid(major = "x", minor="x", size.minor = 0.5, colour.minor = "grey90")
salmonqpcrQcorr <- ggplot(salmon_qpcr_env_use, aes(SampleDate, Qcfscorr_qpcr)) + geom_line() + xlab("") + ylab("Qcfs_corr_qPCR") + background_grid(major = "x", minor="x", size.minor = 0.5, colour.minor = "grey90")
Q_cfs <- ggplot(salmon_qpcr_env_use, aes(SampleDate, Q_cfs)) + geom_line() + xlab("") + ylab("Q_cfs") + background_grid(major = "x", minor="x", size.minor = 0.5, colour.minor = "grey90")
water <- ggplot(salmon_qpcr_env_use, aes(SampleDate, Gage_Height)) + geom_line() + xlab("") + ylab("Gage Height") + background_grid(major = "x", minor="x", size.minor = 0.5, colour.minor = "grey90")
temp <- ggplot(salmon_qpcr_env_use, aes(SampleDate, Avg_Temp)) + geom_line() + xlab("") + ylab("Avg Temp") + background_grid(major = "x", minor="x", size.minor = 0.5, colour.minor = "grey90")

plot_grid(salmoncount1, salmoncount2, salmonqpcrQcorr, salmonqpcr, Q_cfs, water, temp, nrow = 7, align = "v")


# background_grid(major = c("xy", "x", "y", "only_minor", "none"), minor = c("xy", "x", "y", "none"), size.major = 0.2, size.minor = 0.5, colour.major = "grey90", colour.minor = "grey98")
```

http://ggplot2.tidyverse.org/reference/facet_grid.html
https://cran.r-project.org/web/packages/cowplot/vignettes/introduction.html



```{r}
salmoncount <- salmon_qpcr_env_use$Chinook_Total # Chinook_Adult, Chinook_Mini, Chinook_Total

with(salmon_qpcr_env_use, plot(salmoncount, Qty_ng_per_ul_mean))
with(salmon_qpcr_env_use, plot(salmoncount, Qcfscorr_qpcr))
mdl1 <- lm(salmoncount ~ Qcfscorr_qpcr, data=salmon_qpcr_env_use)
summary(mdl1)
par(mfrow=c(2,2))
plot(mdl1)
par(mfrow=c(1,1))
```

```{r}
plot(residuals(mdl1), type="b")
abline(h=0, lty=3)
```

```{r}
acf(residuals(mdl1))
```

```{r}
mdl1.ac <- gls(salmoncount ~ Qcfscorr_qpcr, data=salmon_qpcr_env_use,
              correlation = corAR1(form=~Qcfscorr_qpcr),
              na.action=na.omit)
summary(mdl1.ac)
```

```{r}
coef(mdl1)
coef(mdl1.ac)
qqnorm(mdl1.ac)
```

```{r}
acf(residuals(mdl1.ac, type="p"))
```

```{r}
model.sel(mdl1, mdl1.ac)
```




Tutorial on how to analyse time series
https://rpubs.com/markpayne/164550
```{r}
ccf() # used to calculate cross-correlation of two univariate time series
```

https://onlinecourses.science.psu.edu/stat510/node/75/
https://stats.stackexchange.com/questions/29096/correlation-between-two-time-series
https://svds.com/avoiding-common-mistakes-with-time-series/


don't run this code
Set up github remote on https://github.com/dougwyu/2017_2016_Auke_qPCR
https://www.r-bloggers.com/rstudio-and-github/
Open Terminal
```{bash, }
git remote add origin https://github.com/dougwyu/2017_2016_Auke_qPCR.git
git config remote.origin.url git@github.com:dougwyu/2017_2016_Auke_qPCR.git
git pull -u origin master
git push -u origin master
```
Pull and Push buttons are now active
https://github.com/dougwyu/2017_2016_Auke_qPCR
